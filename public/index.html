<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostCloak | Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { 
                dark: '#0B0E14', 
                card: '#151A23', 
                input: '#1E2532',
                accent: '#3B82F6',
                success: '#10B981',
                danger: '#EF4444'
            }}}
        }
    </script>
    <style>
        body { background-color: #0B0E14; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(21, 26, 35, 0.95); border: 1px solid rgba(255,255,255,0.05); }
        
        /* Switch Toggle CSS */
        .toggle-checkbox:checked { right: 0; border-color: #3B82F6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3B82F6; }
        .toggle-checkbox { right: 0; z-index: 1; border-color: #4B5563; transition: all 0.3s; }
        .toggle-label { width: 40px; height: 20px; background-color: #374151; transition: all 0.3s; }
        .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="border-b border-gray-800 bg-card px-6 py-4 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-ghost text-accent text-xl"></i>
            <h1 class="text-xl font-bold tracking-tight">GHOST<span class="text-accent">CLOAK</span> PRO</h1>
        </div>
        <button class="text-sm text-gray-400 hover:text-white"><i class="fa-solid fa-right-from-bracket"></i> Sair</button>
    </nav>

    <main class="container mx-auto px-4 py-8 flex-grow max-w-7xl">
        
        <div class="flex justify-between items-end mb-8">
            <div>
                <h2 class="text-2xl font-bold text-white">Dashboard</h2>
                <p class="text-gray-400 text-sm">Gerencie seus links blindados e gere presells.</p>
            </div>
            <button onclick="openModal()" class="bg-accent hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium transition shadow-lg shadow-blue-500/20 flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> Nova Campanha
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass p-6 rounded-xl border-l-4 border-success">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-xs uppercase font-bold">Tr√°fego Aprovado</p>
                        <h3 class="text-3xl font-bold text-white mt-2" id="stat-money">0</h3>
                    </div>
                    <div class="bg-success/10 p-2 rounded text-success"><i class="fa-solid fa-dollar-sign"></i></div>
                </div>
            </div>
            <div class="glass p-6 rounded-xl border-l-4 border-danger">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-xs uppercase font-bold">Bots Bloqueados</p>
                        <h3 class="text-3xl font-bold text-white mt-2" id="stat-bot">0</h3>
                    </div>
                    <div class="bg-danger/10 p-2 rounded text-danger"><i class="fa-solid fa-shield-halved"></i></div>
                </div>
            </div>
            <div class="glass p-6 rounded-xl border-l-4 border-accent">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-xs uppercase font-bold">Campanhas Ativas</p>
                        <h3 class="text-3xl font-bold text-white mt-2" id="stat-campaigns">0</h3>
                    </div>
                    <div class="bg-accent/10 p-2 rounded text-accent"><i class="fa-solid fa-link"></i></div>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl overflow-hidden shadow-2xl">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-800/50 text-gray-400 uppercase text-xs font-semibold">
                        <tr>
                            <th class="p-5">Campanha</th>
                            <th class="p-5">Configura√ß√µes</th>
                            <th class="p-5">Destino (Money)</th>
                            <th class="p-5 text-right">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="campaign-list" class="divide-y divide-gray-800">
                        <tr>
                            <td colspan="4" class="p-8 text-center text-gray-500">Carregando campanhas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="modal-new" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-card border border-gray-700 rounded-2xl w-full max-w-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto">
            
            <div class="p-6 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-card z-10">
                <h3 class="text-xl font-bold text-white">Configurar Nova Campanha</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <form id="create-form" class="p-6 space-y-6">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 font-bold">NOME DA CAMPANHA</label>
                        <input type="text" id="c-name" class="w-full bg-input border border-gray-700 rounded-lg p-3 text-white focus:border-accent outline-none transition" placeholder="Ex: VSL Emagrecimento" required>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 font-bold">SLUG (URL ID)</label>
                        <input type="text" id="c-slug" class="w-full bg-input border border-gray-700 rounded-lg p-3 text-white focus:border-accent outline-none transition" placeholder="ex: pv-01" required>
                    </div>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-success mb-1 font-bold">MONEY PAGE (P√°gina de Vendas)</label>
                        <div class="relative">
                            <i class="fa-solid fa-money-bill-wave absolute left-3 top-3.5 text-success"></i>
                            <input type="url" id="c-money" class="pl-10 w-full bg-input border border-success/30 rounded-lg p-3 text-white outline-none focus:border-success" placeholder="https://..." required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 font-bold">SAFE PAGE (Artigo/G1/Blog)</label>
                        <div class="relative">
                            <i class="fa-solid fa-shield-cat absolute left-3 top-3.5 text-gray-500"></i>
                            <input type="url" id="c-safe" class="pl-10 w-full bg-input border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-white" placeholder="https://..." required>
                        </div>
                    </div>
                </div>

                <div class="bg-input/50 p-4 rounded-xl border border-gray-700/50">
                    <h4 class="text-sm font-bold text-gray-300 mb-4 flex items-center gap-2"><i class="fa-solid fa-filter"></i> Filtros de Prote√ß√£o</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Pa√≠s Permitido</label>
                            <select id="c-country" class="w-full bg-card border border-gray-700 rounded p-2 text-sm text-white">
                                <option value="BR">üáßüá∑ Brasil</option>
                                <option value="US">üá∫üá∏ Estados Unidos</option>
                                <option value="PT">üáµüáπ Portugal</option>
                                <option value="ALL">üåç Todos</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between bg-card p-3 rounded border border-gray-700">
                            <span class="text-sm text-gray-300">Permitir Desktop (PC)</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="c-desktop" checked class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="c-desktop" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-card p-3 rounded border border-gray-700">
                            <span class="text-sm text-gray-300">Bloquear VPN/Proxy</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="c-vpn" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="c-vpn" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label>
                            </div>
                        </div>
                         <div class="flex items-center justify-between bg-card p-3 rounded border border-gray-700">
                            <span class="text-sm text-gray-300">Exigir Social (FB/Insta)</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="c-referer" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="c-referer" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-gray-400 mb-1">Pixel ID (Facebook) - Opcional</label>
                    <input type="text" id="c-pixel" class="w-full bg-input border border-gray-700 rounded-lg p-3 text-white focus:border-accent outline-none" placeholder="1234567890">
                </div>

                <button type="submit" class="w-full bg-accent hover:bg-blue-600 text-white font-bold py-4 rounded-lg transition shadow-lg shadow-blue-500/20 text-lg">
                    CRIAR BLINDAGEM
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api'; 

        function openModal() { document.getElementById('modal-new').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal-new').classList.add('hidden'); }

        async function loadDashboard() {
            try {
                const res = await fetch(`${API_URL}/stats`);
                const data = await res.json();
                
                document.getElementById('stat-campaigns').innerText = data.campaigns ? data.campaigns.length : 0;
                let money = 0, bots = 0;
                if(data.hits) data.hits.forEach(h => h.is_bot ? bots++ : money++);
                document.getElementById('stat-money').innerText = money;
                document.getElementById('stat-bot').innerText = bots;

                const tbody = document.getElementById('campaign-list');
                if(!data.campaigns || data.campaigns.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500">Nenhuma campanha criada.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.campaigns.map(c => `
                    <tr class="hover:bg-white/5 transition border-b border-gray-800">
                        <td class="p-5">
                            <div class="font-bold text-white text-base">${c.name}</div>
                            <div class="text-xs text-gray-500 font-mono mt-1"><i class="fa-solid fa-tag"></i> ${c.slug}</div>
                        </td>
                        <td class="p-5">
                            <div class="flex gap-2 flex-wrap">
                                <span class="text-[10px] bg-gray-800 border border-gray-700 px-2 py-1 rounded text-gray-300">
                                    ${c.country_allowed === 'ALL' ? 'üåç Global' : c.country_allowed}
                                </span>
                                ${!c.allow_desktop ? '<span class="text-[10px] bg-red-900/30 text-red-400 border border-red-900 px-2 py-1 rounded">Mobile Only</span>' : ''}
                                ${c.allow_vpn ? '<span class="text-[10px] bg-yellow-900/30 text-yellow-400 border border-yellow-900 px-2 py-1 rounded">VPN Allowed</span>' : ''}
                            </div>
                        </td>
                        <td class="p-5">
                            <a href="${c.money_page}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 truncate max-w-[200px] block">
                                <i class="fa-solid fa-external-link"></i> Link
                            </a>
                        </td>
                        <td class="p-5 text-right">
                            <button onclick="downloadPresell('${c.slug}', '${c.pixel_id || ''}')" class="bg-gray-700 hover:bg-success hover:text-white text-gray-200 text-xs px-3 py-2 rounded transition flex items-center gap-2 ml-auto">
                                <i class="fa-solid fa-download"></i> Baixar Presell
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error(err);
            }
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Criando...';
            
            const payload = {
                name: document.getElementById('c-name').value,
                slug: document.getElementById('c-slug').value,
                safe_page: document.getElementById('c-safe').value,
                money_page: document.getElementById('c-money').value,
                country_allowed: document.getElementById('c-country').value,
                allow_desktop: document.getElementById('c-desktop').checked,
                allow_vpn: document.getElementById('c-vpn').checked,
                require_referrer: document.getElementById('c-referer').checked,
                pixel_id: document.getElementById('c-pixel').value
            };

            try {
                await fetch(`${API_URL}/campaigns`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                closeModal();
                loadDashboard();
                alert('Campanha criada com sucesso!');
            } catch (err) {
                alert('Erro ao criar campanha.');
            }
            btn.innerHTML = 'CRIAR BLINDAGEM';
        });

        // --- CORRE√á√ÉO DO BUG AQUI ---
        function downloadPresell(slug, pixelId) {
            const domain = window.location.origin; 
            
            // Usamos a barra invertida \ para escapar a tag script
            // Isso impede que o navegador ache que o script da p√°gina acabou aqui
            const phpCode = `<?php
$API_URL = "${domain}/api/cloak";
$CAMPAIGN_SLUG = "${slug}";
$PIXEL_ID = "${pixelId}";

function get_ip() {
    if (isset($_SERVER["HTTP_CF_CONNECTING_IP"])) return $_SERVER["HTTP_CF_CONNECTING_IP"];
    if (isset($_SERVER["HTTP_X_FORWARDED_FOR"])) return explode(',', $_SERVER["HTTP_X_FORWARDED_FOR"])[0];
    return $_SERVER["REMOTE_ADDR"];
}

$payload = json_encode([
    'slug' => $CAMPAIGN_SLUG,
    'user_agent' => $_SERVER['HTTP_USER_AGENT'],
    'referrer' => $_SERVER['HTTP_REFERER'] ?? '',
    'ip' => get_ip(),
    'screen_width' => 1920 
]);

$ch = curl_init($API_URL);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);
curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
curl_setopt($ch, CURLOPT_TIMEOUT, 3);
$response = curl_exec($ch);
curl_close($ch);
$data = json_decode($response, true);

$target = $data['target'] ?? 'https://google.com';
$action = $data['action'] ?? 'safe';

if ($action === 'safe') {
    header("Location: $target");
    exit;
}
?>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando...</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    
    <?php if($PIXEL_ID): ?>
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '<?php echo $PIXEL_ID; ?>');
    fbq('track', 'PageView');
    <\/script>
    <?php endif; ?>

    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col justify-center items-center">
    <div class="bg-white p-8 rounded-lg shadow-md text-center max-w-sm w-full mx-4">
        <div class="loader mx-auto mb-4"></div>
        <h2 class="text-gray-800 font-bold text-lg mb-2">Verificando seguran√ßa...</h2>
        <p class="text-gray-500 text-sm">Voc√™ ser√° redirecionado em instantes.</p>
    </div>

    <script>
        setTimeout(function() {
            window.location.href = "<?php echo $target; ?>";
        }, 1500); 
    <\/script>
</body>
</html>`;

            const blob = new Blob([phpCode], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.php';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        loadDashboard();
    </script>
</body>
</html>
